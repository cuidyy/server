# 《用户文件远程安全存储服务技术文档》

## 一、技术概述
本项目构建一个用户文件远程安全存储服务，采用客户端 - 服务器架构，通过 TCP 协议实现客户端与服务端的通信。服务端基于 MySQL 数据库存储用户信息和图片资源相关数据，对用户密码进行 MD5 加密存储，对图片数据采用 AES128 加密算法进行加密处理，以确保数据的安全性与保密性。

## 二、系统架构
1. **客户端**：
    - 负责与用户进行交互，接收用户输入的操作指令，如登录、注册、图片上传、图片列表获取及图片查看等。
    - 构建 TCP 连接与服务端通信，将用户数据和图片数据按照约定的协议格式进行封装和传输。
    - 对服务端返回的数据进行解析和处理，展示给用户相应的结果，如登录成功提示、图片列表展示、图片内容显示等。
2. **服务端**：
    - 监听特定的 TCP 端口，接收客户端的连接请求和数据传输。
    - 处理客户端的各种请求，包括用户校验、注册、图片上传、图片列表获取及图片内容获取等操作。
    - 与 MySQL 数据库进行交互，执行数据的查询、插入、更新等操作，如验证用户账号密码、存储用户注册信息、记录图片资源信息等。

## 三、数据库设计
1. **用户表（user）**：
    - **用户 ID（id）**：主键，自增长整数，用于唯一标识每个用户。
    - **用户名（username）**：字符串类型，存储用户的登录账号，具有唯一性。
    - **密码（password）**：字符串类型，存储用户密码的 MD5 加密值。

2. **资源表（user_img）**：
    - **图片 ID（image_id）**：主键，自增长整数，用于唯一标识每张图片。
    - **用户名（username）**：外键，关联用户表中的用户名，表明图片所属的用户。
    - **图片名（imagename）**：字符串类型，存储图片的文件名。
    - **存储地址（imagepath）**：字符串类型，记录图片在服务器存储的路径信息。

## 四、客户端技术实现
1. **用户界面开发**：
    - 使用 QT 框架进行客户端界面的设计与开发，创建登录窗口、主窗口等界面。
    - 在登录窗口中，设置账号和密码输入框（LineEidt），以及登录按钮(PushButton)，通过信号与槽机制连接按钮点击事件与登录验证函数。
    - 主窗口中包含图片上传按钮、用户图片列表展示区域（ListView）、图片展示区域（GraphicsView）等。
2. **数据处理与传输**：
    - 利用 QT 的网络模块（QTcpSocket）实现与服务端的 TCP 连接建立、数据发送和接收。
    - 封装 TCP 通信的相关函数，如连接服务器函数、发送数据函数、接收数据函数等，以便在不同的操作（如登录、注册、图片上传等）中复用。
    - 对发送和接收的数据进行序列化和反序列化处理，例如将用户信息或图片数据以JSON格式封装，然后进行BASE64编码后发送给服务端。
    - 接收服务端返回的数据后解析成相应的对象或数据结构进行处理。
3. **图片处理**：
    - 图片选择功能借助 Qt 的 QFileDialog 实现，允许用户选择本地图片文件。
    - 通过 QFile 读取选中图片的二进制数据，利用导入的外部库的 AES128 算法对数据进行加密。在图片上传时将数据传递给 TCP 通信模块发送至服务端。
    - 在获取图片内容后，将接收到的图片数据进行显示处理，使用GraphicsView组件进行展示。


## 五、服务端技术实现
1. **网络监听与连接处理**：
    - 使用libevent 技术监听特定 TCP 端口，等待客户端连接请求。
    - 当接收到客户端连接时，创建对应的事件处理机制，用于接收和处理客户端数据传输。
    - 为提高并发处理能力，对每个客户端连接进行高效的管理与调度，确保数据的及时接收与处理。
2. **请求处理与业务逻辑**：
    - 接收客户端发送的数据后，先进行 Base64 解码，再解析为 JSON 格式，依据其中的请求类型字段判断请求类型（如登录、注册、图片上传等）。
    - 根据不同请求类型调用相应的业务逻辑处理函数。例如，登录请求调用用户校验函数，图片上传请求调用图片存储处理函数等。
    - 业务处理函数与 MySQL 数据库进行交互，通过类 mysqlConn 连接数据库并使用连接池中的连接执行数据库操作。在用户校验函数中查询用户表验证账号密码，在图片上传函数中向资源表插入图片相关信息等。
3. **数据库操作**：
    - 封装类 mysqlConn 对库 mysql.h 中的函数进行封装，提供简洁易用的数据库连接与操作接口。
    - 使用连接池技术存储数据库连接，减少数据库连接创建与销毁的开销，提高数据库操作的性能与效率。在执行数据库查询、插入、更新等操作时，从连接池中获取连接，操作完成后将连接归还连接池。
4. **数据解析与处理**：
    - 对客户端发送的 JSON 数据进行解析，提取出关键信息用于业务处理与数据库操作。
    - 对数据库查询结果或需要返回给客户端的数据进行 JSON 封装和BASE64编码，以便在网络中传输与客户端解析处理。

## 六、安全机制
1. **用户认证**：
    - 客户端将用户输入的账号和密码进行 MD5 加密后发送至服务端。
    - 服务端在用户表中查询账号对应的密码，与客户端传来的加密密码进行比对，若一致则认证成功，否则失败。
2. **数据加密**：
    - 用户密码在客户端进行QT中的QCryptographicHash库进行MD5加密后传输并在数据库中存储加密值，防止密码明文泄露。
    - 图片数据在客户端采用外部库的AES128 加密算法进行加密处理后传输给服务端，服务端存储加密后的图片数据，确保图片数据在传输与存储过程中的保密性。
3. **访问控制**：
    - 根据用户 ID 关联图片资源，普通用户只能操作自己上传的图片资源。服务端在处理图片相关请求时，先验证用户身份与图片所属关系，防止越权访问。

## 七、错误处理与日志记录
1. **客户端错误处理**：
    - 对网络连接错误（如连接超时、连接拒绝等）、图片处理错误（如图片读取失败、加密失败等）、用户输入错误（如账号密码格式错误等）进行捕获与处理，统一使用 QMessageBox::information 弹出错误提示框告知用户。
2. **服务端错误处理**：
    - 对数据库操作错误（如 SQL 语法错误、数据库连接失败等）、网络通信错误（如数据接收错误、发送错误等）进行捕获与处理，记录错误信息到服务端日志文件。
    - 向客户端返回合适的错误消息，告知客户端操作失败及失败原因。
    - 对服务端内部的逻辑错误进行监控与处理，确保系统的稳定性与可靠性。

## 九、部署与运维
1. **部署环境准备**：
    - 在 Windows 系统上安装 Qt 开发环境，用于客户端的运行与开发。
    - 在 Linux 虚拟机上安装 C++编译环境、libevent 库以及相关依赖库，用于服务端的运行与开发。
    - 在 Docker 容器中部署 MySQL 数据库，配置数据库的用户名、密码、端口等参数，并创建所需的数据库表结构。
    - 确保 Windows 客户端与 Linux 服务端之间网络畅通，可互相访问指定的 TCP 端口。
2. **服务端部署**：
    - 将服务端程序编译为可执行文件，上传到 Linux 虚拟机指定目录。
    - 编写启动脚本，启动服务端程序，使其监听指定端口等待客户端连接。在启动过程中，加载数据库连接池配置，初始化相关资源。
3. **客户端部署**：
    - 将客户端程序在 Windows 系统上进行安装或直接运行可执行文件。
    - 在客户端配置文件中设置服务端的 IP 地址和端口信息，以便能够正确连接服务端。

---

以上技术文档详细阐述了用户文件远程安全存储服务的技术实现细节，在项目开发、部署与运维过程中可作为重要参考依据，确保系统的顺利构建与稳定运行。在实际应用中，可根据具体技术选型与业务需求进一步调整与完善相关内容。 